import{_ as t,c as e,o as a,aN as n}from"./chunks/framework.ClnKacJt.js";const k=JSON.parse('{"title":"利用GitHub Actions自动构建go项目的二进制到release","description":"","frontmatter":{"title":"利用GitHub Actions自动构建go项目的二进制到release","date":"2022-12-12T13:10:22.000Z"},"headers":[],"relativePath":"02-github-actions/12-Automatically-build-binary-to-release-of-go-project.md","filePath":"02-github-actions/12-Automatically-build-binary-to-release-of-go-project.md","lastUpdated":1768579861000}'),i={name:"02-github-actions/12-Automatically-build-binary-to-release-of-go-project.md"};function l(r,s,d,p,h,c){return a(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="利用github-actions自动构建go项目的二进制到release" tabindex="-1">利用GitHub Actions自动构建go项目的二进制到release <a class="header-anchor" href="#利用github-actions自动构建go项目的二进制到release" aria-label="Permalink to &quot;利用GitHub Actions自动构建go项目的二进制到release&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>最近 ChatGPT 大火，随之一起火起来的，有一大批基于 ChatGPT 编写的工具，我的项目 <a href="https://github.com/eryajf/chatgpt-dingtalk" target="_blank" rel="noreferrer">chatgpt-dingtalk</a> 也是这批项目中的一个，旨在提供在钉钉群聊中与 ChatGPT 交互的能力。</p><p>这是一个工具类的项目，已经提供了 docker 一键部署的能力。但是也有人只想通过二进制直接部署的方式进行体验，多平台兼容的二进制构建，早已有成熟的 Actions 支持，本文就来介绍一个实现方案。</p><h2 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h2><p>所用 Actions：<a href="https://github.com/wangyoucao577/go-release-action" target="_blank" rel="noreferrer">go-release-action</a></p><p>使用配置其实非常简单，基本上阅读完官方介绍文档就可以上手使用了。</p><p>我们在 workflows 目录下添加如下内容：</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$ cat go-binary-release.yml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build-go-binary</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  release</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">created</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 表示在创建新的 Release 时触发</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  build-go-binary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    strategy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      matrix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        goos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">linux</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">windows</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">darwin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 需要打包的系统</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        goarch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">amd64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arm64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 需要打包的架构</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        exclude</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 排除某些平台和架构</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">goarch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arm64</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            goos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">windows</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/checkout@v3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">wangyoucao577/go-release-action@v1.30</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          github_token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ secrets.GITHUB_TOKEN }}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 一个默认的变量，用来实现往 Release 中添加文件</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          goos</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ matrix.goos }}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          goarch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\${{ matrix.goarch }}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          goversion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.18</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 可以指定编译使用的 Golang 版本</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          binary_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chatgpt-dingtalk&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 可以指定二进制文件的名称</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          extra_files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">README.md config.dev.json</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 需要包含的额外文件</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>配置好之后，我们可以来到 release 页面，点击 <code>Darft a new release</code> 创建完一个 release 之后，这个 Actions 就会自动运行，将不同环境不同架构下的二进制打好了。</p><p>效果如下：</p><p><img src="http://t.eryajf.net/imgs/2022/12/1d8e1511fa8befa5.png" alt="" loading="lazy"></p><h2 id="参数说明" tabindex="-1">参数说明 <a class="header-anchor" href="#参数说明" aria-label="Permalink to &quot;参数说明&quot;">​</a></h2><p>如上 yaml 文件中用到的参数基本上都已经有了注释，这里再对官方目前提供的所有参数做个注释说明：</p><div><table tabindex="0"><thead><tr><th style="text-align:center;">参数名</th><th style="text-align:center;"><strong>必填</strong></th><th style="text-align:center;">说明</th></tr></thead><tbody><tr><td style="text-align:center;">github_token</td><td style="text-align:center;"><strong>是</strong></td><td style="text-align:center;">你的 <code>GITHUB_TOKEN</code> 用于将版本上传到 Github Release。</td></tr><tr><td style="text-align:center;">goos</td><td style="text-align:center;"><strong>是</strong></td><td style="text-align:center;"><code>GOOS</code> 是运行程序的操作系统：darwin、windows、linux 等。</td></tr><tr><td style="text-align:center;">goarch</td><td style="text-align:center;"><strong>是</strong></td><td style="text-align:center;"><code>GOARCH</code> 是运行程序的架构：386、amd64、arm、arm64、s390x、loong64 等。</td></tr><tr><td style="text-align:center;">goamd64</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;"><code>GOAMD64</code> 是正在运行的程序 amd64 微架构级别，从 1.18 开始可用。它只能在 GOARCH 是 amd64 时使用：v1、v2、v3、v4 之一。</td></tr><tr><td style="text-align:center;">goversion</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">Go 编译环境版本。 <code>latest</code> (<a href="https://go.dev/VERSION?m=text" target="_blank" rel="noreferrer">check it here</a>) 是默认的, 可自定义选项有： <code>1.13</code>, <code>1.14</code>, <code>1.15</code>, <code>1.16</code>, <code>1.17</code>, <code>1.18</code>, <code>1.19</code>.</td></tr><tr><td style="text-align:center;">project_path</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">在哪里运行 <code>go build</code> 命令。</td></tr><tr><td style="text-align:center;">binary_name</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">如果不想使用仓库名称作为二进制名字，请指定另一个二进制名称。如果未设置，请使用存储库的基本名称。</td></tr><tr><td style="text-align:center;">pre_command</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">在构建之前将执行的额外命令。如果您不使用 Go 模块，您可能需要使用它来解决依赖性问题。</td></tr><tr><td style="text-align:center;">build_command</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">构建二进制文件的实际命令，通常用 <code>go build</code>. 您可能希望使用其他命令包装器, e.g., <a href="https://github.com/gobuffalo/packr/tree/master/v2" target="_blank" rel="noreferrer">packr2</a>, example <code>build_command: &#39;packr2 build&#39;</code>. 记得用 <code>pre_command</code> 设置 <code>packr2</code> 命令. 它还支持 <code>make</code> (<code>Makefile</code>) 构建方案, example <code>build_command: make</code>. 在这种情况下两者都是 <code>build_flags</code> and <code>ldflags</code> 将被忽略，因为它们应该写在你的 <code>Makefile</code> . 此外，请确保生成的二进制文件放在 Make 运行的路径中, i.e., <code>project_path</code>.</td></tr><tr><td style="text-align:center;">executable_compression</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">用一些第三方工具压缩可执行的二进制文件。它接受带有否参数的压缩命令作为输入，例如 UPX 或 UPX-V。目前只支持 UPX。</td></tr><tr><td style="text-align:center;">build_flags</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">传递给 <code>go build</code> 命令的其他参数。</td></tr><tr><td style="text-align:center;">ldflags</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">要提供给 <code>-ldflags</code> 标志参数的值。</td></tr><tr><td style="text-align:center;">extra_files</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">指定将额外的文件打包的制品内。用空间分隔的多个文件。支持拷贝文件夹，因为内部执行的是 <code>cp -r</code>. E.g., <code>extra_files: LICENSE README.md</code></td></tr><tr><td style="text-align:center;">md5sum</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">与工件一起发布 <code>.md5</code>，默认为 TRUE。</td></tr><tr><td style="text-align:center;">sha256sum</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">与工件一起发布 <code>.sha256</code> ，默认为 FALSE。</td></tr><tr><td style="text-align:center;">release_tag</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">将二进制文件发布到的目标版本标签。它致力于在每次推送时将二进制文件发布到一个指定的发布页面，因为在这种情况下没有目标。如果像大多数人一样，通过 <code>release：[created]</code> 事件触发动作，不要设置它。</td></tr><tr><td style="text-align:center;">release_name</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">替代 <code>release_tag</code> 用于发布目标规范和二进制推送. 给定 <code>release_name</code> 的最新版本将从所有版本中选择。对例如无标签 (草稿) 的有用。</td></tr><tr><td style="text-align:center;">overwrite</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">如果资产已经存在，则覆盖它。默认为 FALSE。</td></tr><tr><td style="text-align:center;">asset_name</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">如果不想使用默认格式，请自定义资产名称 <code>\${BINARY_NAME}-\${RELEASE_TAG}-\${GOOS}-\${GOARCH}</code>. 确保正确设置它，特别是对于必须附加的矩阵用法 <code>-\${{ matrix.goos }}-\${{ matrix.goarch }}</code>. 一个有效的例子可能是 <code>asset_name: binary-name-\${{ matrix.goos }}-\${{ matrix.goarch }}</code>.</td></tr><tr><td style="text-align:center;">retry</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">如果上传失败，重试多少次。默认为 3。</td></tr><tr><td style="text-align:center;">post_command</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;">将为拆解工作执行的额外命令。例如，您可以使用它将工件上传到 AWS s3 或阿里云 OSS</td></tr><tr><td style="text-align:center;">compress_assets</td><td style="text-align:center;"><strong>否</strong></td><td style="text-align:center;"><code>auto</code> 默认将产生一个 <code>zip</code> 文件于 Windows 系统以及 <code>tar.gz</code> 文件于其他. <code>zip</code> 将强制使用 <code>zip</code>. <code>OFF</code> 将禁用资产打包.</td></tr></tbody></table></div><h2 id="遗留问题" tabindex="-1">遗留问题 <a class="header-anchor" href="#遗留问题" aria-label="Permalink to &quot;遗留问题&quot;">​</a></h2><p>如果单个项目，同时配置了自动生成 release 和当前这个构建二进制的 Action，会发现发布 release 之后没有触发构建，这个问题目前还没有找到比较好的解决办法。</p>`,17)])])}const g=t(i,[["render",l]]);export{k as __pageData,g as default};
